
#include "lcd3310.h"
#include "LPC8xx.h"    /* LPC8xx Peripheral Registers */

// to be provided from outside

void lcd_pin_clock(int value);
void lcd_pin_data(int value);
void lcd_pin_datanotcmd(int value);
void lcd_pin_enab(int value);
void lcd_pin_reset(int value);

void delay_ms(uint32_t ms);

const uint8_t font[768]={
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x5F,0x5F,0x00,0x00,0x00,
    0x00,0x03,0x03,0x00,0x03,0x03,0x00,0x00,0x14,0x7F,0x7F,0x14,0x7F,0x7F,0x14,0x00,
    0x00,0x24,0x2E,0x6B,0x6B,0x3A,0x12,0x00,0x4C,0x6A,0x36,0x18,0x6C,0x56,0x32,0x00,
    0x30,0x7E,0x4F,0x59,0x77,0x3A,0x68,0x40,0x00,0x00,0x04,0x07,0x03,0x00,0x00,0x00,
    0x00,0x00,0x1C,0x3E,0x63,0x41,0x00,0x00,0x00,0x00,0x41,0x63,0x3E,0x1C,0x00,0x00,
    0x08,0x2A,0x3E,0x1C,0x1C,0x3E,0x2A,0x08,0x00,0x08,0x08,0x3E,0x3E,0x08,0x08,0x00,
    0x00,0x00,0x80,0xE0,0x60,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,
    0x00,0x00,0x00,0x60,0x60,0x00,0x00,0x00,0x40,0x60,0x30,0x18,0x0C,0x06,0x03,0x01,
    0x00,0x3E,0x7F,0x59,0x4D,0x7F,0x3E,0x00,0x00,0x04,0x06,0x7F,0x7F,0x00,0x00,0x00,
    0x00,0x42,0x63,0x71,0x59,0x4F,0x46,0x00,0x00,0x22,0x63,0x49,0x49,0x7F,0x36,0x00,
    0x18,0x1C,0x16,0x13,0x7F,0x7F,0x10,0x00,0x00,0x27,0x67,0x45,0x45,0x7D,0x39,0x00,
    0x00,0x3C,0x7E,0x4B,0x49,0x79,0x30,0x00,0x00,0x01,0x01,0x71,0x79,0x0F,0x07,0x00,
    0x00,0x36,0x7F,0x49,0x49,0x7F,0x36,0x00,0x00,0x06,0x4F,0x49,0x69,0x3F,0x1E,0x00,
    0x00,0x00,0x00,0x66,0x66,0x00,0x00,0x00,0x00,0x00,0x80,0xE6,0x66,0x00,0x00,0x00,
    0x00,0x08,0x08,0x14,0x14,0x22,0x22,0x00,0x00,0x14,0x14,0x14,0x14,0x14,0x14,0x00,
    0x00,0x22,0x22,0x14,0x14,0x08,0x08,0x00,0x00,0x02,0x03,0x51,0x59,0x0F,0x06,0x00,
    0x00,0x3E,0x63,0x5D,0x5D,0x53,0x1E,0x00,0x00,0x7E,0x7F,0x09,0x09,0x7F,0x7E,0x00,
    0x00,0x7F,0x7F,0x49,0x49,0x7F,0x36,0x00,0x00,0x1C,0x3E,0x63,0x41,0x41,0x41,0x00,
    0x00,0x7F,0x7F,0x41,0x63,0x3E,0x1C,0x00,0x00,0x7F,0x7F,0x49,0x49,0x41,0x41,0x00,
    0x00,0x7F,0x7F,0x09,0x09,0x01,0x01,0x00,0x00,0x3E,0x7F,0x41,0x49,0x7B,0x7A,0x00,
    0x00,0x7F,0x7F,0x08,0x08,0x7F,0x7F,0x00,0x00,0x00,0x41,0x7F,0x7F,0x41,0x00,0x00,
    0x00,0x20,0x60,0x40,0x40,0x7F,0x3F,0x00,0x7F,0x7F,0x08,0x1C,0x36,0x63,0x41,0x00,
    0x00,0x7F,0x7F,0x40,0x40,0x40,0x40,0x00,0x7F,0x7F,0x06,0x0C,0x06,0x7F,0x7F,0x00,
    0x7F,0x7F,0x06,0x0C,0x18,0x7F,0x7F,0x00,0x00,0x3E,0x7F,0x41,0x41,0x7F,0x3E,0x00,
    0x00,0x7F,0x7F,0x09,0x09,0x0F,0x06,0x00,0x3E,0x7F,0x41,0x61,0x7F,0x7E,0x40,0x00,
    0x00,0x7F,0x7F,0x09,0x19,0x7F,0x66,0x00,0x00,0x26,0x6F,0x4D,0x59,0x7B,0x32,0x00,
    0x00,0x01,0x01,0x7F,0x7F,0x01,0x01,0x00,0x00,0x3F,0x7F,0x40,0x40,0x7F,0x3F,0x00,
    0x00,0x0F,0x3F,0x70,0x70,0x3F,0x0F,0x00,0x7F,0x7F,0x30,0x18,0x30,0x7F,0x7F,0x00,
    0x41,0x63,0x36,0x1C,0x1C,0x36,0x63,0x41,0x01,0x03,0x06,0x7C,0x7C,0x06,0x03,0x01,
    0x61,0x71,0x59,0x4D,0x47,0x43,0x41,0x00,0x00,0x00,0x7F,0x7F,0x41,0x41,0x00,0x00,
    0x01,0x03,0x06,0x0C,0x18,0x30,0x60,0x40,0x00,0x00,0x41,0x41,0x7F,0x7F,0x00,0x00,
    0x00,0x04,0x06,0x03,0x03,0x06,0x04,0x00,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x00,
    0x00,0x00,0x00,0x03,0x07,0x04,0x00,0x00,0x00,0x20,0x74,0x54,0x54,0x7C,0x78,0x00,
    0x00,0x7F,0x7F,0x44,0x44,0x7C,0x38,0x00,0x00,0x38,0x7C,0x44,0x44,0x44,0x00,0x00,
    0x00,0x38,0x7C,0x44,0x44,0x7F,0x7F,0x00,0x00,0x38,0x7C,0x54,0x54,0x5C,0x18,0x00,
    0x00,0x04,0x7E,0x7F,0x05,0x05,0x00,0x00,0x00,0x18,0xBC,0xA4,0xA4,0xFC,0x7C,0x00,
    0x00,0x7F,0x7F,0x04,0x04,0x7C,0x78,0x00,0x00,0x00,0x00,0x3D,0x7D,0x40,0x00,0x00,
    0x00,0x80,0x80,0x80,0xFD,0x7D,0x00,0x00,0x00,0x7F,0x7F,0x10,0x38,0x6C,0x44,0x00,
    0x00,0x00,0x00,0x3F,0x7F,0x40,0x00,0x00,0x7C,0x7C,0x0C,0x18,0x0C,0x7C,0x78,0x00,
    0x00,0x7C,0x7C,0x04,0x04,0x7C,0x78,0x00,0x00,0x38,0x7C,0x44,0x44,0x7C,0x38,0x00,
    0x00,0xFC,0xFC,0x24,0x24,0x3C,0x18,0x00,0x00,0x18,0x3C,0x24,0x24,0xFC,0xFC,0x00,
    0x00,0x7C,0x7C,0x04,0x04,0x0C,0x08,0x00,0x00,0x48,0x5C,0x54,0x54,0x74,0x20,0x00,
    0x00,0x04,0x3F,0x7F,0x44,0x44,0x00,0x00,0x00,0x3C,0x7C,0x40,0x40,0x7C,0x7C,0x00,
    0x00,0x1C,0x3C,0x60,0x60,0x3C,0x1C,0x00,0x3C,0x7C,0x60,0x30,0x60,0x7C,0x3C,0x00,
    0x44,0x6C,0x38,0x10,0x38,0x6C,0x44,0x00,0x00,0x1C,0xBC,0xE0,0x60,0x3C,0x1C,0x00,
    0x00,0x44,0x64,0x74,0x5C,0x4C,0x44,0x00,0x00,0x00,0x08,0x3E,0x77,0x41,0x00,0x00,
    0x00,0x00,0x00,0x7F,0x7F,0x00,0x00,0x00,0x00,0x00,0x41,0x77,0x3E,0x08,0x00,0x00,
    0x04,0x06,0x02,0x06,0x04,0x06,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

//------pause for the lcd operations
void lcd_p(void) {
    //    volatile int i,j;
    //    for (i=0;i<1000;i++) j=i+i;
    delay_ms(500);
}

//-----write byte via "simulated" SPI
void lcd_w(uint8_t w) {
    uint8_t tmp=w;
    uint8_t i;
    for (i=0;i<8;i++) {
	lcd_pin_clock(0);
        if (tmp>127) {
	    lcd_pin_data(1);
            tmp-=128;
        } else {
	    lcd_pin_data(0);
	}
	lcd_pin_clock(1);
        tmp=tmp<<1;
    }
}

//-----write lcd command
void lcd_c(uint8_t c) {
    lcd_pin_datanotcmd(0);
    lcd_pin_enab(0);
    lcd_w(c);
    lcd_pin_enab(1);
}

//-----write lcd data
void lcd_d(uint8_t d) {
    lcd_pin_datanotcmd(1);
    lcd_pin_enab(0);
    lcd_w(d);
    lcd_pin_enab(1);
}

//-----reset lcd
void lcd_r(void) {
    lcd_pin_reset(0);
    lcd_p();
    lcd_pin_reset(1);
}

//------clean lcd
void lcd_clr(void) {
    int i;
    lcd_c(0x80);
    lcd_c(0x40);
    for (i=0;i<504;i++) lcd_d(0);
    lcd_c(0x80);
    lcd_c(0x40);
}

//-------lcd init
void lcd_init(void) {
    lcd_p();
    lcd_pin_datanotcmd(1);
    lcd_pin_enab(1);
    lcd_r();
    lcd_c(0x21);
    lcd_c(0xC5); //197 //Voop
    lcd_c(0x13); //bias
    lcd_c(0x20); //horizontal
    lcd_c(0x09); //all
    lcd_c(0x08); //blank
    lcd_c(0x0c); //normal
    lcd_clr();
}

//------set cursor position x=(0..11) y=(0..5)
void lcd_goto(uint8_t x, uint8_t y) {
    lcd_c(0x80+7*x);
    lcd_c(0x40+y);
}

//------write single character
void lcd_wchar(uint8_t c) {
    int i,p;
    //p=(c-32)<<3;
    if (c>=32) {
	p=(c-32)<<3;	
    } else {
	p=0;    
    } 	    
    for (i=0;i<7;i++) lcd_d(font[p+i]);
}

//------write single digits (0..9)
void lcd_wdig(uint8_t d) {
    lcd_wchar(48+d);
}

//------write byte (0..255)
void lcd_wbyte(uint8_t b) {
    uint8_t tmp=b;
    uint8_t d1,d2,d3;
    d1=tmp/100;
    tmp-=d1*100;
    d2=tmp/10;
    d3=tmp-d2*10;
    lcd_wdig(d1);
    lcd_wdig(d2);
    lcd_wdig(d3);
}

//------write string
void lcd_wstr(const char *c) {
    uint8_t p=0;
    while (c[p]!=0) {
        lcd_wchar(c[p]);
        p++;
    }

}

//------write long int
void lcd_wlong(long int x) {
    long int tmp = x;
    long int d = 1000000000;
    long int i;
    uint8_t f=0;
    if (tmp<0) {
        tmp=0-tmp;
        lcd_wchar('-');
    }
    while (tmp>10) {
        i=tmp / d;
        if ((i>0) || (f==1)) {
            lcd_wdig(i);
            f=1;
        }
        tmp-=i*d;
        d=d / 10;
    }
    lcd_wdig(tmp);
}

//------write int
void lcd_wint(int x) {
    int tmp = x;
    int d = 10000;
    int i;
    uint8_t f=0;
    if (tmp<0) {
        tmp=0-tmp;
        lcd_wchar('-');
    }
    while (tmp>10) {
        i=tmp / d;
        if ((i>0) || (f==1)) {
            lcd_wdig(i);
            f=1;
        }
        tmp-=i*d;
        d=d / 10;
    }
    lcd_wdig(tmp);
}

//------write unsigned int
void lcd_wuint(unsigned int x) {
    unsigned int tmp = x;
    unsigned int d = 10000;
    unsigned int i;
    uint8_t f=0;
    while (tmp>10) {
        i=tmp / d;
        if ((i>0) || (f==1)) {
            lcd_wdig(i);
            f=1;
        }
        tmp-=i*d;
        d=d / 10;
    }
    lcd_wdig(tmp);
}

//-----draw vertical line
void lcd_vline(uint8_t x, uint8_t y1, uint8_t y2) {
    //uint8_t xpos=0x80+x;
    uint8_t yy1=y1;
    uint8_t yy2=y2;
    uint8_t p,y,i,yy;
    if (yy2<yy1) {
        yy1=y2;
        yy2=y1;
    }
    yy=0;
    for (y=0;y<6;y++) {
        p=0;
        for (i=0;i<8;i++) {
            p=p>>1;
            if ((yy>=yy1) && (yy<=yy2)) p+=128;
            yy++;
        }
        lcd_c(0x80+x);
        lcd_c(0x40+y);
        lcd_d(p);
    }
}

